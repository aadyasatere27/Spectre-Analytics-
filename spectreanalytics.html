<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPECTRE ANALYTICS | Financial Energy Monitor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        zinc: {
                            950: '#09090b',
                            900: '#18181b',
                            800: '#27272a',
                            700: '#3f3f46',
                            600: '#52525b',
                            500: '#71717a',
                            400: '#a1a1aa',
                        },
                        lime: {
                            400: '#a3e635',
                            500: '#84cc16',
                        },
                        emerald: {
                            400: '#34d399',
                            500: '#10b981',
                        }
                    },
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace'],
                        sans: ['ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 2px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #52525b; }
        body { background-color: #000; color: #f4f4f5; }
        .chart-container { position: relative; height: 100%; width: 100%; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #notification-dropdown { transform-origin: top right; transition: all 0.2s ease-out; }
        #notification-dropdown.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        #notification-dropdown:not(.hidden) { opacity: 1; transform: scale(1); pointer-events: auto; }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden text-zinc-100 font-sans selection:bg-lime-500/30" onclick="handleBodyClick(event)">

    <div id="modal-overlay" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md hidden transition-opacity duration-200">
        <div class="bg-zinc-950 w-full max-w-2xl rounded-2xl border border-zinc-800 shadow-2xl overflow-hidden transform transition-all duration-200 scale-95" id="modal-content">
            <div id="modal-header" class="px-6 py-4 border-b border-zinc-800 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div id="modal-icon-container" class="p-3 rounded-lg bg-black/40 shadow-lg"></div>
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h3 id="modal-title" class="text-xl font-bold"></h3>
                            <span id="modal-asset-id" class="bg-black/40 px-2 py-0.5 rounded text-[10px] font-mono text-zinc-400 border border-zinc-800"></span>
                        </div>
                        <p id="modal-timestamp" class="text-zinc-400 text-xs font-mono"></p>
                    </div>
                </div>
                <button onclick="closeModal()" class="text-zinc-500 hover:text-white transition-colors p-2 hover:bg-white/10 rounded-full">
                    <i data-lucide="x" width="20"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <div class="space-y-3">
                    <h4 class="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="activity" width="16" class="text-zinc-500"></i> The Problem
                    </h4>
                    <div class="bg-zinc-900/50 p-4 rounded-xl border border-zinc-800 text-zinc-300 text-sm leading-relaxed">
                        <span id="modal-desc"></span>
                        <div class="mt-4 flex gap-6 text-xs font-mono text-zinc-500 pt-3 border-t border-zinc-800/50">
                            <div class="flex flex-col"><span class="text-[10px] uppercase">Expected</span><span id="modal-expected" class="text-lime-400 font-bold text-lg"></span></div>
                            <div class="flex flex-col"><span class="text-[10px] uppercase">Actual</span><span id="modal-actual" class="text-white font-bold text-lg"></span></div>
                            <div class="flex flex-col"><span class="text-[10px] uppercase">Waste</span><span id="modal-waste" class="text-red-400 font-bold text-lg"></span></div>
                        </div>
                    </div>
                </div>
                <div class="space-y-3">
                    <h4 class="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="wrench" width="16" class="text-zinc-500"></i> Remediation Steps
                    </h4>
                    <div id="modal-steps" class="bg-zinc-900/50 rounded-xl border border-zinc-800 overflow-hidden"></div>
                </div>
            </div>
            <div class="px-6 py-4 bg-zinc-900/50 border-t border-zinc-800 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 rounded-lg text-xs font-bold text-zinc-400 hover:text-white hover:bg-zinc-800 transition-colors">Dismiss</button>
                <button onclick="closeModal()" class="px-4 py-2 rounded-lg bg-lime-400 text-black text-xs font-bold hover:bg-lime-300 transition-colors flex items-center gap-2"><i data-lucide="check-circle-2" width="14"></i> Assign Technician</button>
            </div>
        </div>
    </div>

    <header class="h-18 border-b border-zinc-800 flex items-center justify-between px-6 py-4 bg-zinc-950/80 backdrop-blur-md sticky top-0 z-50">
        <div class="flex items-center gap-10">
            <div class="flex items-center gap-3 text-white font-bold text-xl tracking-tight group cursor-pointer" onclick="switchTab('overview')">
                <div class="relative">
                    <i data-lucide="alert-octagon" width="28" class="text-lime-400 transition-transform group-hover:rotate-12" stroke-width="2.5"></i>
                    <div class="absolute inset-0 bg-lime-400/20 blur-lg rounded-full animate-pulse"></div>
                </div>
                <div>SPECTRE<span class="text-zinc-500 font-light">ANALYTICS</span></div>
            </div>
            
            <nav class="hidden md:flex items-center gap-2">
                <div onclick="switchTab('overview')" id="nav-overview" class="nav-item flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-all text-sm font-medium bg-zinc-800 text-white shadow-sm ring-1 ring-zinc-700">
                    <i data-lucide="layout-dashboard" width="16"></i><span>Overview</span>
                </div>
                <div onclick="switchTab('savings')" id="nav-savings" class="nav-item flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-all text-sm font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800/50">
                    <i data-lucide="dollar-sign" width="16"></i><span>Savings</span>
                </div>
                <div onclick="switchTab('incidents')" id="nav-incidents" class="nav-item flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-all text-sm font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800/50">
                    <i data-lucide="alert-triangle" width="16"></i><span>Incidents</span>
                </div>
            </nav>
        </div>
        
        <div class="flex items-center gap-5 relative">
            <div class="relative hidden lg:block group">
                <i data-lucide="search" width="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-lime-400 transition-colors"></i>
                <input 
                    id="search-input"
                    type="text" 
                    placeholder="Search Asset ID (Enter)..." 
                    onkeyup="handleSearch(event)"
                    class="bg-zinc-900/50 border border-zinc-800 rounded-full pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-lime-500/50 focus:bg-zinc-900 focus:ring-1 focus:ring-lime-500/20 text-zinc-300 w-64 transition-all placeholder:text-zinc-600"
                >
            </div>
            
            <div id="header-play-btn" onclick="toggleLive()" class="h-9 w-9 rounded-full bg-zinc-900 flex items-center justify-center border border-zinc-800 hover:border-zinc-600 cursor-pointer relative transition-colors group" title="Pause/Resume Feed">
                <i id="header-play-icon" data-lucide="pause" width="14" class="text-zinc-400 group-hover:text-white"></i>
                <span id="play-status-dot" class="absolute top-0 right-0 w-2 h-2 bg-lime-500 rounded-full border border-zinc-950 animate-pulse"></span>
            </div>

            <div id="notification-btn" onclick="toggleNotifications(event)" class="h-9 w-9 rounded-full bg-zinc-900 flex items-center justify-center border border-zinc-800 hover:border-zinc-600 cursor-pointer relative transition-colors">
                <i data-lucide="bell" width="16" class="text-zinc-400"></i>
                <span id="notification-dot" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-zinc-950 hidden"></span>
            </div>

            <div id="notification-dropdown" class="absolute top-12 right-0 w-80 bg-zinc-950 border border-zinc-800 rounded-xl shadow-2xl hidden z-50">
                <div class="p-3 border-b border-zinc-800 flex justify-between items-center bg-zinc-900/50 rounded-t-xl">
                    <span class="text-xs font-bold text-zinc-300 uppercase tracking-wider">Critical Alerts</span>
                    <span class="text-[10px] bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded border border-red-500/20">Live</span>
                </div>
                <div id="notification-list" class="max-h-64 overflow-y-auto custom-scrollbar">
                    <div class="p-4 text-center text-zinc-600 text-xs">No active critical alerts.</div>
                </div>
                <div class="p-2 border-t border-zinc-800 bg-zinc-900/50 rounded-b-xl">
                    <button onclick="switchTab('incidents'); renderIncidents('critical');" class="w-full py-1.5 text-xs text-zinc-400 hover:text-white hover:bg-zinc-800 rounded transition-colors">View All Critical Events</button>
                </div>
            </div>

            <div class="h-9 w-9 rounded-full bg-gradient-to-br from-lime-400 to-emerald-600 p-[1px] cursor-pointer">
                <div class="h-full w-full rounded-full bg-zinc-950 flex items-center justify-center">
                   <span class="font-bold text-xs text-lime-400">SA</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 p-6 overflow-y-auto custom-scrollbar">
        <div class="max-w-[1600px] mx-auto space-y-6">

            <div id="view-overview" class="tab-content active space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gradient-to-br from-zinc-900 to-zinc-950 rounded-xl p-6 border border-zinc-800 relative overflow-hidden group">
                        <div class="text-zinc-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i data-lucide="zap" width="14" class="text-lime-400"></i> Total Waste
                        </div>
                        <div class="text-4xl font-bold text-white mb-2 font-mono tracking-tighter">
                            <span id="stat-total-waste">0</span> <span class="text-lg text-zinc-600 font-sans">kW</span>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-red-300 bg-red-500/10 border border-red-500/10 w-fit px-2.5 py-1 rounded-md">
                            <i data-lucide="arrow-up-right" width="12"></i> +12.5% vs Avg
                        </div>
                    </div>

                    <div class="bg-zinc-900/50 backdrop-blur-sm rounded-xl p-5 border border-zinc-800 flex flex-col justify-between hover:border-zinc-700 transition-all duration-300 group">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-2 text-zinc-400 text-xs font-semibold uppercase tracking-wider group-hover:text-zinc-300 transition-colors">
                                <i data-lucide="activity" width="16" stroke-width="1.5"></i> System Efficiency
                            </div>
                            <i data-lucide="more-horizontal" width="16" class="text-zinc-700 group-hover:text-zinc-500 transition-colors cursor-pointer"></i>
                        </div>
                        <div>
                            <div id="stat-efficiency" class="text-3xl font-bold text-zinc-100 mb-2 font-mono tracking-tight">98%</div>
                            <div id="stat-efficiency-badge" class="text-xs font-medium flex items-center gap-1.5 px-2 py-1 rounded-full w-fit text-lime-300 bg-lime-500/10 border border-lime-500/20">
                                <i data-lucide="arrow-up-right" width="12"></i>
                                <span id="stat-efficiency-text">Optimal State</span>
                            </div>
                        </div>
                    </div>
                    
                    <div onclick="switchTab('incidents')" class="bg-zinc-900/50 backdrop-blur-sm rounded-xl p-5 border border-zinc-800 flex flex-col justify-between hover:border-lime-500/30 hover:bg-zinc-800 cursor-pointer transition-all duration-300 group">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-2 text-zinc-400 text-xs font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                                <i data-lucide="alert-octagon" width="16" stroke-width="1.5"></i> Active Anomalies
                            </div>
                            <i data-lucide="arrow-right" width="16" class="text-zinc-700 group-hover:text-lime-400 transition-colors -translate-x-2 opacity-0 group-hover:opacity-100 group-hover:translate-x-0"></i>
                        </div>
                        <div>
                            <div id="stat-anomalies" class="text-3xl font-bold text-zinc-100 mb-2 font-mono tracking-tight">0</div>
                            <div class="text-xs font-medium flex items-center gap-1.5 px-2 py-1 rounded-full w-fit text-lime-300 bg-lime-500/10 border border-lime-500/20">
                                <i data-lucide="arrow-up-right" width="12"></i>
                                View Log
                            </div>
                        </div>
                    </div>

                    <div class="bg-zinc-900/50 rounded-xl p-6 border border-zinc-800 relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 p-4 opacity-[0.03] group-hover:opacity-[0.05] transition-opacity">
                        
                        </div>
                        <div class="flex items-center gap-2 text-zinc-400 text-xs font-bold uppercase tracking-widest mb-4">
                            <i data-lucide="leaf" width="14" class="text-emerald-400"></i> Carbon Footprint
                        </div>
                        <div class="text-4xl font-bold text-white mb-2 font-mono tracking-tighter">
                            <span id="stat-carbon">0</span> <span class="text-lg text-zinc-600 font-sans">kg/h</span>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-emerald-400 bg-emerald-500/10 border border-emerald-500/10 w-fit px-2.5 py-1 rounded-md">
                            <i data-lucide="check" width="12"></i> Within Limits
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]">
                    <div class="lg:col-span-2 bg-zinc-900/50 rounded-xl border border-zinc-800 p-6 flex flex-col shadow-sm backdrop-blur-sm">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-4">
                                <div class="p-2 bg-zinc-800 rounded-lg border border-zinc-700">
                                    <i data-lucide="activity" width="18" class="text-lime-400"></i>
                                </div>
                                <div>
                                    <h2 class="text-lg font-bold text-white tracking-tight">Hourly Telemetry</h2>
                                    <p class="text-xs text-zinc-500">Hourly load verification (24h)</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-3 text-xs font-medium bg-zinc-950/50 px-3 py-1.5 rounded-full border border-zinc-800">
                                    <div class="flex items-center gap-1.5 text-zinc-300"><div class="w-2 h-2 bg-lime-400 rounded-full shadow-[0_0_8px_rgba(163,230,53,0.5)]"></div> Baseline</div>
                                    <div class="w-px h-3 bg-zinc-800"></div>
                                    <div class="flex items-center gap-1.5 text-zinc-300"><div class="w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_8px_rgba(245,158,11,0.5)]"></div> Actual</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 min-h-0 w-full relative">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-zinc-900/50 rounded-xl border border-zinc-800 p-6 flex flex-col relative overflow-hidden backdrop-blur-sm">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h2 class="text-lg font-bold text-white tracking-tight">GRID CAPACITY</h2>
                                <p class="text-xs text-zinc-500">System Load Factor</p>
                            </div>
                        </div>
                        <div class="flex-1 relative flex items-center justify-center">
                            <div class="w-full h-[200px] flex items-end justify-center pb-6">
                                <canvas id="capacityChart"></canvas>
                            </div>
                            
                            <div class="absolute inset-0 flex flex-col items-center justify-end pb-12 pointer-events-none">
                                <span id="gauge-val" class="text-4xl font-bold text-white font-mono">0 kW</span>
                                <span class="text-zinc-500 text-[10px] uppercase tracking-widest font-bold mt-1">Current Load</span>
                            </div>
                        </div>
                        <div class="mt-auto space-y-3">
                            <div class="flex justify-between items-center text-sm p-3 bg-zinc-950/50 rounded-lg border border-zinc-800/50">
                                <span class="text-zinc-400 flex items-center gap-2 font-medium">Safe Limit</span>
                                <span class="text-lime-400 font-mono">100 kW</span>
                            </div>
                            <div class="flex justify-between items-center text-sm p-3 bg-zinc-950/50 rounded-lg border border-zinc-800/50">
                                <span class="text-zinc-400 flex items-center gap-2 font-medium">Max Capacity</span>
                                <span class="text-zinc-500 font-mono">120 kW</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-savings" class="tab-content space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-zinc-900/50 rounded-xl p-6 border border-zinc-800 relative overflow-hidden flex flex-col justify-between group">
                        <div class="absolute inset-0 bg-red-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="flex items-center gap-2 text-zinc-400 text-xs font-bold uppercase tracking-widest mb-1 z-10">
                            <i data-lucide="flame" width="14" class="text-red-500"></i> Cash Burn Rate
                        </div>
                        <div class="z-10">
                            <div class="text-3xl font-bold text-white font-mono tracking-tighter" id="stat-burn-rate">$0.00</div>
                            <div class="text-[10px] text-zinc-500 mt-1 uppercase font-bold">Per Hour</div>
                        </div>
                    </div>

                    <div class="bg-zinc-900/50 rounded-xl p-6 border border-zinc-800 relative overflow-hidden flex flex-col justify-between">
                        <div class="flex items-center gap-2 text-zinc-400 text-xs font-bold uppercase tracking-widest mb-1">
                            <i data-lucide="trending-down" width="14" class="text-zinc-500"></i> Daily Loss
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-white font-mono tracking-tighter" id="stat-money-lost">$0.00</div>
                            <div class="text-[10px] text-zinc-500 mt-1 uppercase font-bold">Last 24 Hours</div>
                        </div>
                    </div>
                    
                    <div class="bg-zinc-900/50 rounded-xl p-6 border border-zinc-800 relative overflow-hidden flex flex-col justify-between">
                        <div class="flex items-center gap-2 text-zinc-400 text-xs font-bold uppercase tracking-widest mb-1">
                            <i data-lucide="piggy-bank" width="14" class="text-lime-400"></i> Potential Savings
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-lime-400 font-mono tracking-tighter" id="stat-potential-savings">$0.00</div>
                            <div class="text-[10px] text-zinc-500 mt-1 uppercase font-bold">Annual Projection</div>
                        </div>
                    </div>

                    <div class="bg-zinc-900/50 rounded-xl p-6 border border-zinc-800 relative overflow-hidden flex flex-col justify-between">
                         <div class="flex items-center gap-2 text-zinc-400 text-xs font-bold uppercase tracking-widest mb-1">
                            <i data-lucide="target" width="14" class="text-blue-400"></i> Spend ROI
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-white font-mono tracking-tighter" id="stat-roi">0%</div>
                            <div class="text-[10px] text-zinc-500 mt-1 uppercase font-bold">Efficiency Rating</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[400px]">
                    <div class="lg:col-span-2 bg-zinc-900/50 rounded-xl border border-zinc-800 p-6 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2">
                                <i data-lucide="bar-chart-2" width="16" class="text-zinc-500"></i> Cost Velocity
                            </h2>
                            <div class="flex gap-2">
                                <span class="flex items-center gap-1 text-[10px] text-zinc-400"><div class="w-2 h-2 rounded-full bg-zinc-700"></div> Efficient</span>
                                <span class="flex items-center gap-1 text-[10px] text-zinc-400"><div class="w-2 h-2 rounded-full bg-red-500"></div> Waste</span>
                            </div>
                        </div>
                        <div class="flex-1 w-full relative">
                            <canvas id="financeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-zinc-900/50 rounded-xl border border-zinc-800 p-6 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                             <h2 class="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2">
                                <i data-lucide="pie-chart" width="16" class="text-zinc-500"></i> Waste Sources
                            </h2>
                        </div>
                        <div class="flex-1 w-full relative">
                             <canvas id="wastePieChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-zinc-900/50 rounded-xl border border-zinc-800 overflow-hidden flex flex-col h-[300px]">
                    <div class="p-4 border-b border-zinc-800 flex items-center justify-between">
                        <h2 class="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2">
                            <i data-lucide="alert-triangle" width="16" class="text-red-500"></i> High Impact Assets
                        </h2>
                        <span class="text-[10px] text-zinc-500 uppercase font-bold">Ranked by Financial Loss</span>
                    </div>
                    <div class="overflow-y-auto custom-scrollbar flex-1">
                        <table class="w-full text-left text-sm text-zinc-400">
                            <thead class="bg-zinc-950/50 sticky top-0 z-10 backdrop-blur-md">
                                <tr class="border-b border-zinc-800 text-[10px] font-bold uppercase tracking-wider text-zinc-500">
                                    <th class="py-2 pl-4 w-12">#</th>
                                    <th class="py-2">Asset ID</th>
                                    <th class="py-2">Primary Issue</th>
                                    <th class="py-2 text-right">Events</th>
                                    <th class="py-2 pr-4 text-right">Total Loss</th>
                                </tr>
                            </thead>
                            <tbody id="top-offenders-body" class="divide-y divide-zinc-800/50">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-incidents" class="tab-content h-full">
                <div class="bg-zinc-900/50 rounded-xl border border-zinc-800 overflow-hidden flex flex-col h-[75vh]">
                    <div class="p-6 border-b border-zinc-800 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <h2 class="text-xl font-bold text-white tracking-tight" id="incidents-header">Full Incident Log</h2>
                            <div class="flex gap-2">
                                <button onclick="renderIncidents('all')" class="px-3 py-1.5 rounded-lg bg-zinc-800 text-xs font-medium text-white hover:bg-zinc-700 transition">All</button>
                                <button onclick="renderIncidents('critical')" class="px-3 py-1.5 rounded-lg bg-red-900/20 text-xs font-medium text-red-400 border border-red-900/30 hover:bg-red-900/30 transition">Critical</button>
                                <button onclick="renderIncidents('invisible')" class="px-3 py-1.5 rounded-lg bg-amber-900/20 text-xs font-medium text-amber-400 border border-amber-900/30 hover:bg-amber-900/30 transition">Invisible</button>
                            </div>
                        </div>
                        <button id="clear-search-btn" onclick="clearSearch()" class="hidden px-3 py-1.5 rounded-lg border border-zinc-700 text-xs text-zinc-400 hover:text-white hover:bg-zinc-800 flex items-center gap-2">
                            <i data-lucide="x" width="12"></i> Clear Search
                        </button>
                    </div>
                    <div class="overflow-y-auto custom-scrollbar flex-1">
                        <table class="w-full text-left text-sm text-zinc-400">
                            <thead class="bg-zinc-950/50 sticky top-0 z-10 backdrop-blur-md">
                                <tr class="border-b border-zinc-800 text-[10px] font-bold uppercase tracking-wider text-zinc-500">
                                    <th class="py-4 pl-8 font-mono w-32">Time</th>
                                    <th class="py-4 w-48">Classification</th>
                                    <th class="py-4 w-40">Asset ID</th>
                                    <th class="py-4">Details</th>
                                    <th class="py-4 w-32 text-right">Waste</th>
                                    <th class="py-4 pr-8 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="incidents-table-body" class="divide-y divide-zinc-800/50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- DATA & STATE ---
        const anomalyDatabase = {
            critical: [
                { type: "Surge Event", asset: "MAIN-FEED-A", desc: "Sudden voltage spike detected exceeding safety ratings (120% nominal).", fix: ["Check surge protection devices (SPD).", "Inspect transformer tap settings."] },
                { type: "Phase Imbalance", asset: "PUMP-MAIN-01", desc: "Uneven load distribution >3% across 3-phase power.", fix: ["Redistribute single-phase loads.", "Check for loose connections."] },
                { type: "Breaker Risk", asset: "DIST-PANEL-4", desc: "Current draw approaching 95% of breaker trip curve.", fix: ["Immediate load shedding.", "Thermographic scan of breaker."] },
                { type: "Harmonic Distortion", asset: "VFD-BANK-B", desc: "THD levels exceeding IEEE 519 limits (>5%).", fix: ["Inspect line reactors.", "Check active harmonic filters."] },
                { type: "Thermal Overload", asset: "CHILLER-02", desc: "Sustained high amperage causing dangerous heat buildup.", fix: ["Inspect cooling fans/fins.", "Check for refrigerant overcharge."] }
            ],
            invisible: [
                { type: "Phantom Drain", asset: "OFFICE-LIGHTS", desc: "Load active during scheduled unoccupied hours.", fix: ["Adjust lighting control schedule.", "Check occupancy sensor sensitivity."] },
                { type: "Cycle Shorting", asset: "COMPRESSOR-A", desc: "Rapid ON/OFF cycling (<5 min intervals).", fix: ["Increase deadband differential.", "Check thermostat location."] },
                { type: "Idle Load", asset: "CONVEYOR-03", desc: "Motor running with zero production throughput.", fix: ["Interlock motor with production line.", "Install auto-idle VFD routine."] },
                { type: "Drift Error", asset: "SENSOR-TEMP-4", desc: "Sensor reading deviating >5Â°F from reality.", fix: ["Recalibrate sensor.", "Check for sensor fouling/dust."] },
                { type: "Steam Trap Leak", asset: "BOILER-ROOM", desc: "Ultrasonic signature suggests blow-through steam.", fix: ["Isolate and replace trap.", "Check condensate return temp."] }
            ]
        };

        let appState = {
            data: [],
            wasteEvents: [],
            stats: { totalWaste: 0, detectionCount: 0, currentEfficiency: 98, moneyLost: 0, moneySpent: 0 },
            financials: {
                assets: {}, 
                categories: {}
            },
            isLive: true,
            currentHour: 12,
            activeTab: 'overview',
            searchQuery: ''
        };

        let intervalId = null;
        let mainChart = null;
        let capacityChart = null; // Replaced donutChart
        let financeChart = null;
        let wastePieChart = null;

        // --- CONFIG ---
        Chart.defaults.font.family = 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace';
        Chart.defaults.color = '#71717a';
        const COST_PER_KWH = 0.14; 

        // --- TAB SWITCHING ---
        function switchTab(tabName) {
            appState.activeTab = tabName;
            ['overview', 'savings', 'incidents'].forEach(t => {
                const el = document.getElementById(`view-${t}`);
                const nav = document.getElementById(`nav-${t}`);
                if (t === tabName) {
                    el.classList.add('active');
                    if (nav) {
                        nav.classList.remove('text-zinc-400', 'hover:text-zinc-200', 'hover:bg-zinc-800/50');
                        nav.classList.add('bg-zinc-800', 'text-white', 'shadow-sm', 'ring-1', 'ring-zinc-700');
                    }
                } else {
                    el.classList.remove('active');
                    if (nav) {
                        nav.classList.add('text-zinc-400', 'hover:text-zinc-200', 'hover:bg-zinc-800/50');
                        nav.classList.remove('bg-zinc-800', 'text-white', 'shadow-sm', 'ring-1', 'ring-zinc-700');
                    }
                }
            });

            if (tabName === 'incidents') {
                if(!appState.searchQuery) renderIncidents('all');
                else renderIncidents('search');
            }
            if (tabName === 'savings') renderSavingsView();
        }

        // --- SEARCH & NOTIFICATIONS ---

        function handleSearch(event) {
            if (event.key === 'Enter') {
                const query = event.target.value.trim().toUpperCase();
                if (query) {
                    appState.searchQuery = query;
                    switchTab('incidents');
                    renderIncidents('search');
                }
            }
        }

        function clearSearch() {
            appState.searchQuery = '';
            document.getElementById('search-input').value = '';
            renderIncidents('all');
        }

        function toggleNotifications(e) {
            if(e) e.stopPropagation();
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('hidden');
            
            if (!dropdown.classList.contains('hidden')) {
                updateNotificationList();
            }
        }

        function handleBodyClick(e) {
            const dropdown = document.getElementById('notification-dropdown');
            const btn = document.getElementById('notification-btn');
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        }

        function updateNotificationList() {
            const list = document.getElementById('notification-list');
            const criticalEvents = appState.wasteEvents.filter(e => !e.isInvisible);
            
            if (criticalEvents.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-zinc-600 text-xs">No active critical alerts.</div>`;
                return;
            }

            list.innerHTML = criticalEvents.slice(0, 5).map(event => {
                const safeEventStr = encodeURIComponent(JSON.stringify(event));
                return `
                <div onclick="openModal('${safeEventStr}'); toggleNotifications()" class="p-3 border-b border-zinc-800/50 hover:bg-zinc-900 cursor-pointer group">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-red-400 text-xs font-bold">${event.classification}</span>
                        <span class="text-[10px] text-zinc-500 font-mono">${event.time}</span>
                    </div>
                    <div class="text-[10px] text-zinc-400 font-mono mb-1">ID: ${event.assetId}</div>
                </div>
                `;
            }).join('');
        }

        // --- LOGIC FUNCTIONS ---
        function generateHourlyPoint(hourOverride = null) {
            let hour = hourOverride !== null ? hourOverride : (appState.currentHour + 1) % 24;
            appState.currentHour = hour;
            const timeLabel = hour.toString().padStart(2, '0') + ":00";
            
            let baseLoad = 30;
            if (hour >= 9 && hour <= 17) baseLoad = 75;
            else if (hour >= 6 && hour <= 8) baseLoad = 50;
            else if (hour >= 18 && hour <= 22) baseLoad = 45;

            const expectedPattern = Math.round(baseLoad + (Math.random() - 0.5) * 8);
            let actualConsumption = expectedPattern + ((Math.random() - 0.5) * 5);
            
            const isAnomaly = Math.random() > 0.65;
            let anomalyData = null;
            let anomalyType = null;

            if (isAnomaly) {
                if (Math.random() > 0.65) {
                    actualConsumption = 92 + (Math.random() * 15);
                    anomalyType = "critical";
                    anomalyData = anomalyDatabase.critical[Math.floor(Math.random() * anomalyDatabase.critical.length)];
                } else {
                    actualConsumption += 15 + (Math.random() * 12);
                    anomalyType = "invisible";
                    anomalyData = anomalyDatabase.invisible[Math.floor(Math.random() * anomalyDatabase.invisible.length)];
                }
            }

            actualConsumption = Math.round(Math.max(0, actualConsumption));
            const isWaste = anomalyType !== null;
            const wasteAmount = isWaste ? Math.round(actualConsumption - expectedPattern) : 0;
            const costLost = wasteAmount * COST_PER_KWH;
            const costSpent = (actualConsumption - wasteAmount) * COST_PER_KWH;

            if (isWaste && anomalyData) {
                if (!appState.financials.assets[anomalyData.asset]) {
                    appState.financials.assets[anomalyData.asset] = { cost: 0, count: 0, type: anomalyData.type };
                }
                appState.financials.assets[anomalyData.asset].cost += costLost;
                appState.financials.assets[anomalyData.asset].count += 1;

                if (!appState.financials.categories[anomalyData.type]) {
                    appState.financials.categories[anomalyData.type] = 0;
                }
                appState.financials.categories[anomalyData.type] += costLost;
            }

            return {
                time: timeLabel,
                actual: actualConsumption,
                expected: expectedPattern,
                isWaste: isWaste,
                isInvisible: anomalyType === "invisible",
                classification: anomalyData ? anomalyData.type : "Normal",
                assetId: anomalyData ? anomalyData.asset : "N/A",
                fullDetails: anomalyData,
                wasteAmount: wasteAmount,
                severityScore: isWaste ? Math.min(100, Math.round((wasteAmount / 40) * 100)) : 0,
                costLost: costLost,
                costSpent: costSpent,
                id: crypto.randomUUID()
            };
        }

        // --- DOM & CHARTS ---
        function initCharts() {
            // 1. Hourly Load Line Chart
            const ctxMain = document.getElementById('mainChart').getContext('2d');
            const gradient = ctxMain.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(245, 158, 11, 0.3)');
            gradient.addColorStop(1, 'rgba(245, 158, 11, 0)');

            mainChart = new Chart(ctxMain, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Expected', data: [], borderColor: '#a3e635', borderWidth: 2, pointRadius: 0, tension: 0.4 },
                        { label: 'Actual', data: [], borderColor: '#f59e0b', backgroundColor: gradient, fill: true, borderWidth: 2, pointRadius: 0, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#27272a' }, ticks: { color: '#71717a', maxRotation: 0 } },
                        y: { grid: { color: '#27272a' }, min: 0, max: 120, ticks: { color: '#71717a' } }
                    }
                }
            });

            // 2. Capacity Gauge (Revamped Donut)
            const ctxCapacity = document.getElementById('capacityChart').getContext('2d');
            capacityChart = new Chart(ctxCapacity, {
                type: 'doughnut',
                data: {
                    labels: ['Load', 'Capacity'],
                    datasets: [{
                        data: [50, 50],
                        backgroundColor: ['#a3e635', '#27272a'], // Lime and Dark
                        borderWidth: 0,
                        circumference: 180,
                        rotation: -90,
                        cutout: '80%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }

        // --- SAVINGS TAB RENDERER ---
        function renderSavingsView() {
            const burnRate = (appState.stats.moneyLost / 24).toFixed(2);
            document.getElementById('stat-burn-rate').innerText = '$' + burnRate;
            document.getElementById('stat-potential-savings').innerText = '$' + (appState.stats.moneyLost * 365).toLocaleString(undefined, {maximumFractionDigits: 0});
            
            const totalSpend = appState.stats.moneyLost + appState.stats.moneySpent;
            const roi = totalSpend > 0 ? ((appState.stats.moneySpent / totalSpend) * 100).toFixed(1) : 0;
            document.getElementById('stat-roi').innerText = roi + '%';

            const ctxFinance = document.getElementById('financeChart').getContext('2d');
            let cumulativeLoss = 0;
            let cumulativeSpend = 0;
            const lossData = appState.data.map(d => { cumulativeLoss += d.costLost; return cumulativeLoss; });
            const spendData = appState.data.map(d => { cumulativeSpend += d.costSpent; return cumulativeSpend; });
            const labels = appState.data.map(d => d.time);

            if (financeChart) {
                financeChart.data.labels = labels;
                financeChart.data.datasets[0].data = spendData;
                financeChart.data.datasets[1].data = lossData;
                financeChart.update();
            } else {
                financeChart = new Chart(ctxFinance, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Efficient Spend', data: spendData, borderColor: '#a3e635', backgroundColor: '#a3e635', fill: false, borderWidth: 2, pointRadius: 0 },
                            { label: 'Money Lost (Waste)', data: lossData, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, borderWidth: 2, pointRadius: 0 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#71717a' } },
                            y: { grid: { color: '#27272a' }, ticks: { color: '#71717a', callback: (val) => '$' + val } }
                        }
                    }
                });
            }

            const ctxPie = document.getElementById('wastePieChart').getContext('2d');
            const categories = Object.keys(appState.financials.categories);
            const values = Object.values(appState.financials.categories);
            
            if (wastePieChart) {
                wastePieChart.data.labels = categories;
                wastePieChart.data.datasets[0].data = values;
                wastePieChart.update();
            } else {
                wastePieChart = new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: values,
                            backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899', '#14b8a6'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 10, color: '#71717a', font: {size: 10} } } }
                    }
                });
            }

            const offendersBody = document.getElementById('top-offenders-body');
            const sortedAssets = Object.entries(appState.financials.assets)
                .sort(([,a], [,b]) => b.cost - a.cost)
                .slice(0, 5);
            
            if(sortedAssets.length === 0) {
                 offendersBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-zinc-600 text-xs">No data available yet.</td></tr>`;
            } else {
                offendersBody.innerHTML = sortedAssets.map(([id, data], index) => `
                    <tr class="border-b border-zinc-800/50 hover:bg-zinc-800/30 transition">
                        <td class="py-2 pl-4 w-12 text-zinc-500 text-xs font-mono">${index + 1}</td>
                        <td class="py-2 text-white text-xs font-mono font-bold">${id}</td>
                        <td class="py-2 text-zinc-400 text-xs">${data.type}</td>
                        <td class="py-2 text-right text-zinc-500 text-xs font-mono">${data.count}</td>
                        <td class="py-2 pr-4 text-right text-red-400 text-xs font-mono font-bold">$${data.cost.toFixed(2)}</td>
                    </tr>
                `).join('');
            }
        }

        function renderIncidents(filter) {
            const tbody = document.getElementById('incidents-table-body');
            const header = document.getElementById('incidents-header');
            const clearBtn = document.getElementById('clear-search-btn');
            
            let events = appState.wasteEvents;
            
            if (filter === 'search') {
                events = events.filter(e => e.assetId.includes(appState.searchQuery));
                header.innerText = `Search Results: "${appState.searchQuery}"`;
                clearBtn.classList.remove('hidden');
            } else {
                header.innerText = "Full Incident Log";
                clearBtn.classList.add('hidden');
                if (filter === 'critical') events = events.filter(e => !e.isInvisible);
                if (filter === 'invisible') events = events.filter(e => e.isInvisible);
            }

            if (events.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="py-12 text-center text-zinc-600">No events found matching your criteria.</td></tr>`;
                return;
            }

            tbody.innerHTML = events.map(event => {
                const badgeColor = event.isInvisible ? 'bg-amber-500/10 text-amber-500 border-amber-500/20' : 'bg-red-500/10 text-red-500 border-red-500/20';
                const safeEventStr = encodeURIComponent(JSON.stringify(event));
                
                return `
                    <tr class="hover:bg-zinc-900 transition border-b border-zinc-800/50 last:border-0">
                        <td class="py-4 pl-8 font-mono text-xs text-zinc-500">${event.time}</td>
                        <td class="py-4">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border ${badgeColor}">
                                ${event.classification}
                            </span>
                        </td>
                        <td class="py-4 font-mono text-xs text-zinc-300">
                             ${appState.searchQuery && event.assetId.includes(appState.searchQuery) 
                                ? `<span class="bg-lime-500/20 text-lime-300 px-1 rounded">${event.assetId}</span>` 
                                : event.assetId}
                        </td>
                        <td class="py-4 text-xs text-zinc-500 truncate max-w-xs">${event.fullDetails?.desc || 'Unknown error'}</td>
                        <td class="py-4 text-right font-mono text-red-400 text-xs">+${event.wasteAmount} kW</td>
                        <td class="py-4 pr-8 text-right">
                             <button onclick="openModal('${safeEventStr}')" class="text-xs font-bold text-zinc-400 hover:text-white underline">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateUI() {
            // Stats
            document.getElementById('stat-total-waste').innerText = appState.stats.totalWaste.toLocaleString();
            document.getElementById('stat-efficiency').innerText = Math.round(appState.stats.currentEfficiency) + '%';
            document.getElementById('stat-anomalies').innerText = appState.stats.detectionCount;

            // Notification Dot
            const criticalCount = appState.wasteEvents.filter(e => !e.isInvisible).length;
            const dot = document.getElementById('notification-dot');
            if (criticalCount > 0) dot.classList.remove('hidden');
            else dot.classList.add('hidden');

            // Daily Loss KPI
            document.getElementById('stat-money-lost').innerText = '$' + appState.stats.moneyLost.toFixed(2);

            // Efficiency Badge
            const eff = appState.stats.currentEfficiency;
            const badge = document.getElementById('stat-efficiency-badge');
            if (eff < 90) {
                badge.className = "text-xs font-medium flex items-center gap-1.5 px-2 py-1 rounded-full w-fit text-red-300 bg-red-500/10 border border-red-500/20";
                document.getElementById('stat-efficiency-text').innerText = "Degradation";
            } else {
                badge.className = "text-xs font-medium flex items-center gap-1.5 px-2 py-1 rounded-full w-fit text-lime-300 bg-lime-500/10 border border-lime-500/20";
                document.getElementById('stat-efficiency-text').innerText = "Optimal State";
            }

            // Overview Charts
            mainChart.data.labels = appState.data.map(d => d.time);
            mainChart.data.datasets[0].data = appState.data.map(d => d.expected);
            mainChart.data.datasets[1].data = appState.data.map(d => d.actual);
            mainChart.update('none');

            // --- UPDATE CAPACITY GAUGE ---
            const current = appState.data[appState.data.length - 1];
            if (current && capacityChart) {
                const actual = current.actual;
                const maxLoad = 120; // arbitrary max
                const safeLoad = 100;

                document.getElementById('gauge-val').innerText = actual + " kW";
                
                // Determine Gauge Color
                let gaugeColor = '#a3e635'; // Lime
                if (actual > safeLoad) gaugeColor = '#f59e0b'; // Amber
                if (actual > 110) gaugeColor = '#ef4444'; // Red

                capacityChart.data.datasets[0].backgroundColor = [gaugeColor, '#27272a'];
                capacityChart.data.datasets[0].data = [actual, Math.max(0, maxLoad - actual)];
                capacityChart.update('none');
                
                // Carbon Calc (Approx 0.4 kg per kW)
                document.getElementById('stat-carbon').innerText = (actual * 0.4).toFixed(1);
            }

            // Re-render open views
            if (appState.activeTab === 'savings') renderSavingsView();
            if (appState.activeTab === 'incidents' && !appState.searchQuery) renderIncidents('all');

            lucide.createIcons();
        }

        function tick() {
            const newPoint = generateHourlyPoint();
            appState.data.push(newPoint);
            if (appState.data.length > 24) appState.data.shift();

            if (newPoint.isWaste) {
                appState.wasteEvents.unshift(newPoint);
                if (appState.wasteEvents.length > 100) appState.wasteEvents.pop();
                appState.stats.totalWaste += newPoint.wasteAmount;
                appState.stats.detectionCount += 1;
                appState.stats.currentEfficiency = Math.max(0, 100 - (newPoint.wasteAmount * 0.8));
            } else {
                appState.stats.currentEfficiency = Math.min(100, appState.stats.currentEfficiency + 2);
            }
            
            appState.stats.moneyLost += newPoint.costLost;
            appState.stats.moneySpent += newPoint.costSpent;

            updateUI();
        }

        function toggleLive() {
            appState.isLive = !appState.isLive;
            const btn = document.getElementById('header-play-btn');
            const icon = document.getElementById('header-play-icon');
            const dot = document.getElementById('play-status-dot');
            
            if (appState.isLive) {
                intervalId = setInterval(tick, 2000);
                icon.setAttribute('data-lucide', 'pause');
                dot.className = "absolute top-0 right-0 w-2 h-2 bg-lime-500 rounded-full border border-zinc-950 animate-pulse";
            } else {
                clearInterval(intervalId);
                icon.setAttribute('data-lucide', 'play');
                dot.className = "absolute top-0 right-0 w-2 h-2 bg-zinc-500 rounded-full border border-zinc-950";
            }
            lucide.createIcons();
        }

        function openModal(encodedEvent) {
            const event = JSON.parse(decodeURIComponent(encodedEvent));
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            const isHidden = event.isInvisible;
            const colorClass = isHidden ? "text-amber-400" : "text-red-500";
            
            document.getElementById('modal-title').innerText = event.classification;
            document.getElementById('modal-title').className = `text-xl font-bold ${colorClass}`;
            document.getElementById('modal-asset-id').innerText = `ID: ${event.assetId}`;
            document.getElementById('modal-timestamp').innerText = `Timestamp: ${event.time}`;
            document.getElementById('modal-desc').innerText = event.fullDetails?.desc;
            document.getElementById('modal-expected').innerText = event.expected + " kW";
            document.getElementById('modal-actual').innerText = event.actual + " kW";
            document.getElementById('modal-waste').innerText = "+" + event.wasteAmount + " kW";
            
            const iconContainer = document.getElementById('modal-icon-container');
            iconContainer.innerHTML = isHidden ? '<i data-lucide="zap-off" width="28"></i>' : '<i data-lucide="alert-triangle" width="28"></i>';
            iconContainer.className = `p-3 rounded-lg bg-black/40 ${colorClass} shadow-lg`;

            document.getElementById('modal-steps').innerHTML = (event.fullDetails?.fix || []).map((step, i) => `
                <div class="p-4 border-b border-zinc-800/50 flex items-center gap-3"><div class="w-5 h-5 rounded-full bg-zinc-800 flex items-center justify-center text-xs text-zinc-500">${i+1}</div><p class="text-zinc-300 text-sm">${step}</p></div>
            `).join('');

            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 10);
            lucide.createIcons();
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => overlay.classList.add('hidden'), 200);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const startHour = appState.currentHour;
            for (let i = 24; i > 0; i--) {
                const point = generateHourlyPoint((startHour - i + 24) % 24);
                appState.data.push(point);
                appState.stats.moneyLost += point.costLost;
                appState.stats.moneySpent += point.costSpent;
            }
            appState.wasteEvents = appState.data.filter(d => d.isWaste).reverse();
            appState.currentHour = startHour;

            initCharts();
            updateUI();
            intervalId = setInterval(tick, 2000);
            lucide.createIcons();
        });
    </script>
</body>
</html>
